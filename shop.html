<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Blue Chess.in - Avatar Shop</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="shortcut icon" href="files/img/-s-logo.png" type="image/png">
<style>
    body { font-family: Arial, sans-serif; background: #e9f4ff; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #004890; }
    .shop { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
    .item {
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        text-align: center;
        width: 150px;
    }
    .item img { width: 100px; height: 100px; border-radius: 8px; }
    .price { margin: 10px 0; font-weight: bold; width: 10px; }
    button {
        background: #004890;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
    }
    button:hover { background: #003370; }
    .price img {
        height: 16px;
        width: 16px;
        vertical-align: middle;
        margin-left: 0px;
    }
    button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    #home {
        background: #004890;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        position: fixed;
        top: 20px;
        right: 20px;
    }
</style>
</head>
<body>
<h1>Avatar Shop</h1>
<button id="home" onclick="window.location.href='home.html'">Go Home</button>
<div class="shop" id="shop"></div>

<script type="module">
const SUPABASE_URL = "https://ruevzmnbhoowmuleeqjb.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1ZXZ6bW5iaG9vd211bGVlcWpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzOTUzNTIsImV4cCI6MjA2OTk3MTM1Mn0.tt_xEAqLGiv92mvqhQaEvsjTBE6cmYDC3kkQcyPqsTY";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

async function checkMaintenance() {
  const { data, error } = await supabaseClient
    .from("settings")
    .select("maintenance, message")
    .limit(1)
    .single();

  if (data?.maintenance) {
    window.location.href = "maintenance.html";
  }
}
checkMaintenance();

// Load shop
async function loadShop() {
  console.log("Loading shop...");

  // Auth check
  const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
  if (userError || !user) {
    console.error("User error:", userError);
    alert("Login required");
    window.location.href = "index.html";
    return;
  }

  // Get owned avatars
  const { data: owned, error: ownedError } = await supabaseClient
    .from("owned_avatars")
    .select("avatar_path")
    .eq("user_id", user.id);

  const ownedSet = new Set((owned || []).map(a => a.avatar_path));

  // Fetch shop items
  const { data: shopItems, error: shopError } = await supabaseClient
    .from("shop_items")
    .select("id, file_name, price, category");

  if (shopError) {
    console.error("Shop load error:", shopError);
    return;
  }

  const shopDiv = document.getElementById("shop");
  shopDiv.innerHTML = "";

  shopItems.forEach(item => {
    const publicUrl = `https://ruevzmnbhoowmuleeqjb.supabase.co/storage/v1/object/public/avatars/buyable/${item.file_name}`;
    const alreadyOwned = ownedSet.has(`buyable/${item.file_name}`);

    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <img src="${publicUrl}" alt="${item.file_name}">
      <div class="price">${item.price} <img src="files/img/-s-blue-rook.png" height="16"></div>
      <div class="category">Category: ${item.category}</div>
      <button ${alreadyOwned ? "disabled" : ""} 
        onclick="buyAvatar('${item.file_name}', ${item.price}, this)">
        ${alreadyOwned ? "Owned" : "Buy"}
      </button>
    `;
    shopDiv.appendChild(div);
  });
}

window.buyAvatar = async function(fileName, price, btn) {
  btn.disabled = true;
  console.log(`Buying avatar: ${fileName} for ${price}`);

  const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
  if (userError || !user) {
    alert("Login required");
    window.location.href = "index.html";
    return;
  }

  // Get balance
  const { data: profile, error: profileError } = await supabaseClient
    .from("profiles")
    .select("blue_rooks")
    .eq("id", user.id)
    .single();

  if (profileError || !profile) {
    alert("Profile error");
    btn.disabled = false;
    return;
  }

  if ((profile.blue_rooks ?? 0) < price) {
    alert("Not enough Blue Rooks!");
    btn.disabled = false;
    return;
  }

  // Deduct and add avatar
  const updateRes = await supabaseClient
    .from("profiles")
    .update({ blue_rooks: profile.blue_rooks - price })
    .eq("id", user.id);

  if (updateRes.error) {
    alert("Failed to update balance.");
    btn.disabled = false;
    return;
  }

  const insertRes = await supabaseClient
    .from("owned_avatars")
    .insert({ user_id: user.id, avatar_path: `buyable/${fileName}` });

  if (insertRes.error) {
    alert("Failed to add avatar.");
    btn.disabled = false;
    return;
  }

  alert("Avatar purchased!");
  await loadShop();
};

// Run shop on page load
loadShop();
</script>



